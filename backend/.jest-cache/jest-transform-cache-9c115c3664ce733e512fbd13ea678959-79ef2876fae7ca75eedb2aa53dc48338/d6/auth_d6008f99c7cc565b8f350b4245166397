2558ce5ac6b36da97cfb79460e61971b
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.authorizeOwnerOrAdmin = exports.authorize = exports.authenticate = exports.requireAdminOrModerator = exports.requireAdmin = exports.requireRole = exports.authenticateToken = void 0;
const authService_1 = require("../services/authService");
const logger_1 = __importDefault(require("../utils/logger"));
/**
 * Middleware de autenticação JWT
 */
const authenticateToken = async (req, res, next) => {
    try {
        const authHeader = req.headers.authorization;
        const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN
        if (!token) {
            res.status(401).json({
                success: false,
                message: 'Token de acesso requerido'
            });
            return;
        }
        // Verificar token usando authService
        const decoded = await authService_1.authService.verifyAccessToken(token);
        if (!decoded) {
            res.status(401).json({
                success: false,
                message: 'Token inválido ou expirado'
            });
            return;
        }
        // Buscar usuário no banco de dados
        const user = await authService_1.authService.getUserById(decoded.userId);
        if (!user) {
            res.status(401).json({
                success: false,
                message: 'Usuário não encontrado'
            });
            return;
        }
        // Adicionar usuário ao request
        req.user = {
            id: user.id,
            email: user.email,
            role: user.role
        };
        next();
    }
    catch (error) {
        logger_1.default.error('Erro na autenticação', { error: error.message });
        res.status(401).json({
            success: false,
            message: 'Token inválido'
        });
    }
};
exports.authenticateToken = authenticateToken;
/**
 * Middleware para verificar roles específicas
 */
const requireRole = (roles) => {
    return (req, res, next) => {
        const user = req.user;
        if (!user) {
            res.status(401).json({
                success: false,
                message: 'Usuário não autenticado'
            });
            return;
        }
        if (!roles.includes(user.role)) {
            res.status(403).json({
                success: false,
                message: 'Acesso negado. Permissão insuficiente'
            });
            return;
        }
        next();
    };
};
exports.requireRole = requireRole;
/**
 * Middleware para verificar se é admin
 */
exports.requireAdmin = (0, exports.requireRole)(['ADMIN']);
/**
 * Middleware para verificar se é admin ou moderador
 */
exports.requireAdminOrModerator = (0, exports.requireRole)(['ADMIN', 'MODERATOR']);
/**
 * Alias para compatibilidade com código existente
 */
exports.authenticate = exports.authenticateToken;
const authorize = (...roles) => {
    return (0, exports.requireRole)(roles);
};
exports.authorize = authorize;
const authorizeOwnerOrAdmin = (req, res, next) => {
    const user = req.user;
    const resourceUserId = req.params.id || req.params.userId;
    if (!user) {
        res.status(401).json({
            success: false,
            message: 'Usuário não autenticado'
        });
        return;
    }
    // Permite se for admin ou se for o próprio usuário
    if (user.role === 'ADMIN' || user.id === resourceUserId) {
        next();
        return;
    }
    res.status(403).json({
        success: false,
        message: 'Acesso negado. Você só pode acessar seus próprios recursos'
    });
};
exports.authorizeOwnerOrAdmin = authorizeOwnerOrAdmin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiRDpcXGRldlxcY29udGFiaWxcXGNvbnRhYmlsLXNpdGVcXGJhY2tlbmRcXHNyY1xcbWlkZGxld2FyZXNcXGF1dGgudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBRUEseURBQXNEO0FBQ3RELDZEQUFxQztBQWtCckM7O0dBRUc7QUFDSSxNQUFNLGlCQUFpQixHQUFHLEtBQUssRUFDcEMsR0FBWSxFQUNaLEdBQWEsRUFDYixJQUFrQixFQUNILEVBQUU7SUFDakIsSUFBSSxDQUFDO1FBQ0gsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUM7UUFDN0MsTUFBTSxLQUFLLEdBQUcsVUFBVSxJQUFJLFVBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxlQUFlO1FBRXJFLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNYLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNuQixPQUFPLEVBQUUsS0FBSztnQkFDZCxPQUFPLEVBQUUsMkJBQTJCO2FBQ3JDLENBQUMsQ0FBQztZQUNILE9BQU87UUFDVCxDQUFDO1FBRUQscUNBQXFDO1FBQ3JDLE1BQU0sT0FBTyxHQUFHLE1BQU0seUJBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUUzRCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDYixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDbkIsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsT0FBTyxFQUFFLDRCQUE0QjthQUN0QyxDQUFDLENBQUM7WUFDSCxPQUFPO1FBQ1QsQ0FBQztRQUVELG1DQUFtQztRQUNuQyxNQUFNLElBQUksR0FBRyxNQUFNLHlCQUFXLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUUzRCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDVixHQUFHLENBQUMsTUFBTSxDQUFD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REFBbUQ7SUFDbkQsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sSUFBSSxJQUFJLENBQUMsRUFBRSxLQUFLLGNBQWMsRUFBRSxDQUFDO1FBQ3hELElBQUksRUFBRSxDQUFDO1FBQ1AsT0FBTztJQUNULENBQUM7SUFFRCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNuQixPQUFPLEVBQUUsS0FBSztRQUNkLE9BQU8sRUFBRSw0REFBNEQ7S0FDdEUsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBdEJXLFFBQUEscUJBQXFCLHlCQXNCaEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiRDpcXGRldlxcY29udGFiaWxcXGNvbnRhYmlsLXNpdGVcXGJhY2tlbmRcXHNyY1xcbWlkZGxld2FyZXNcXGF1dGgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcclxuaW1wb3J0IHsgYXV0aFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9hdXRoU2VydmljZSc7XHJcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vdXRpbHMvbG9nZ2VyJztcclxuXHJcbi8vIEludGVyZmFjZSBwYXJhIHBheWxvYWQgZG8gSldUXHJcblxyXG5cclxuLy8gRXN0ZW5kZXIgaW50ZXJmYWNlIFJlcXVlc3QgcGFyYSBpbmNsdWlyIHVzZXJcclxuZGVjbGFyZSBnbG9iYWwge1xyXG4gIG5hbWVzcGFjZSBFeHByZXNzIHtcclxuICAgIGludGVyZmFjZSBSZXF1ZXN0IHtcclxuICAgICAgdXNlcj86IHtcclxuICAgICAgICBpZDogc3RyaW5nO1xyXG4gICAgICAgIGVtYWlsOiBzdHJpbmc7XHJcbiAgICAgICAgcm9sZTogc3RyaW5nO1xyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIE1pZGRsZXdhcmUgZGUgYXV0ZW50aWNhw6fDo28gSldUXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgYXV0aGVudGljYXRlVG9rZW4gPSBhc3luYyAoXHJcbiAgcmVxOiBSZXF1ZXN0LFxyXG4gIHJlczogUmVzcG9uc2UsXHJcbiAgbmV4dDogTmV4dEZ1bmN0aW9uXHJcbik6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbjtcclxuICAgIGNvbnN0IHRva2VuID0gYXV0aEhlYWRlciAmJiBhdXRoSGVhZGVyLnNwbGl0KCcgJylbMV07IC8vIEJlYXJlciBUT0tFTlxyXG5cclxuICAgIGlmICghdG9rZW4pIHtcclxuICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgIG1lc3NhZ2U6ICdUb2tlbiBkZSBhY2Vzc28gcmVxdWVyaWRvJ1xyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFZlcmlmaWNhciB0b2tlbiB1c2FuZG8gYXV0aFNlcnZpY2VcclxuICAgIGNvbnN0IGRlY29kZWQgPSBhd2FpdCBhdXRoU2VydmljZS52ZXJpZnlBY2Nlc3NUb2tlbih0b2tlbik7XHJcblxyXG4gICAgaWYgKCFkZWNvZGVkKSB7XHJcbiAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBtZXNzYWdlOiAnVG9rZW4gaW52w6FsaWRvIG91IGV4cGlyYWRvJ1xyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEJ1c2NhciB1c3XDoXJpbyBubyBiYW5jbyBkZSBkYWRvc1xyXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IGF1dGhTZXJ2aWNlLmdldFVzZXJCeUlkKGRlY29kZWQudXNlcklkKTtcclxuXHJcbiAgICBpZiAoIXVzZXIpIHtcclxuICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgIG1lc3NhZ2U6ICdVc3XDoXJpbyBuw6NvIGVuY29udHJhZG8nXHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQWRpY2lvbmFyIHVzdcOhcmlvIGFvIHJlcXVlc3RcclxuICAgIHJlcS51c2VyID0ge1xyXG4gICAgICBpZDogdXNlci5pZCxcclxuICAgICAgZW1haWw6IHVzZXIuZW1haWwsXHJcbiAgICAgIHJvbGU6IHVzZXIucm9sZVxyXG4gICAgfTtcclxuXHJcbiAgICBuZXh0KCk7XHJcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgbG9nZ2VyLmVycm9yKCdFcnJvIG5hIGF1dGVudGljYcOnw6NvJywgeyBlcnJvcjogZXJyb3IubWVzc2FnZSB9KTtcclxuICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgIG1lc3NhZ2U6ICdUb2tlbiBpbnbDoWxpZG8nXHJcbiAgICB9KTtcclxuICB9XHJcbn07XHJcblxyXG4vKipcclxuICogTWlkZGxld2FyZSBwYXJhIHZlcmlmaWNhciByb2xlcyBlc3BlY8OtZmljYXNcclxuICovXHJcbmV4cG9ydCBjb25zdCByZXF1aXJlUm9sZSA9IChyb2xlczogc3RyaW5nW10pID0+IHtcclxuICByZXR1cm4gKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogdm9pZCA9PiB7XHJcbiAgICBjb25zdCB1c2VyID0gcmVxLnVzZXI7XHJcblxyXG4gICAgaWYgKCF1c2VyKSB7XHJcbiAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcclxuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICBtZXNzYWdlOiAnVXN1w6FyaW8gbsOjbyBhdXRlbnRpY2FkbydcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXJvbGVzLmluY2x1ZGVzKHVzZXIucm9sZSkpIHtcclxuICAgICAgcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xyXG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxyXG4gICAgICAgIG1lc3NhZ2U6ICdBY2Vzc28gbmVnYWRvLiBQZXJtaXNzw6NvIGluc3VmaWNpZW50ZSdcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBuZXh0KCk7XHJcbiAgfTtcclxufTtcclxuXHJcbi8qKlxyXG4gKiBNaWRkbGV3YXJlIHBhcmEgdmVyaWZpY2FyIHNlIMOpIGFkbWluXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgcmVxdWlyZUFkbWluID0gcmVxdWlyZVJvbGUoWydBRE1JTiddKTtcclxuXHJcbi8qKlxyXG4gKiBNaWRkbGV3YXJlIHBhcmEgdmVyaWZpY2FyIHNlIMOpIGFkbWluIG91IG1vZGVyYWRvclxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IHJlcXVpcmVBZG1pbk9yTW9kZXJhdG9yID0gcmVxdWlyZVJvbGUoWydBRE1JTicsICdNT0RFUkFUT1InXSk7XHJcblxyXG4vKipcclxuICogQWxpYXMgcGFyYSBjb21wYXRpYmlsaWRhZGUgY29tIGPDs2RpZ28gZXhpc3RlbnRlXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgYXV0aGVudGljYXRlID0gYXV0aGVudGljYXRlVG9rZW47XHJcbmV4cG9ydCBjb25zdCBhdXRob3JpemUgPSAoLi4ucm9sZXM6IHN0cmluZ1tdKSA9PiB7XHJcbiAgcmV0dXJuIHJlcXVpcmVSb2xlKHJvbGVzKTtcclxufTtcclxuZXhwb3J0IGNvbnN0IGF1dGhvcml6ZU93bmVyT3JBZG1pbiA9IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQgPT4ge1xyXG4gIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcclxuICBjb25zdCByZXNvdXJjZVVzZXJJZCA9IHJlcS5wYXJhbXMuaWQgfHwgcmVxLnBhcmFtcy51c2VySWQ7XHJcblxyXG4gIGlmICghdXNlcikge1xyXG4gICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xyXG4gICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgbWVzc2FnZTogJ1VzdcOhcmlvIG7Do28gYXV0ZW50aWNhZG8nXHJcbiAgICB9KTtcclxuICAgIHJldHVybjtcclxuICB9XHJcblxyXG4gIC8vIFBlcm1pdGUgc2UgZm9yIGFkbWluIG91IHNlIGZvciBvIHByw7NwcmlvIHVzdcOhcmlvXHJcbiAgaWYgKHVzZXIucm9sZSA9PT0gJ0FETUlOJyB8fCB1c2VyLmlkID09PSByZXNvdXJjZVVzZXJJZCkge1xyXG4gICAgbmV4dCgpO1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuXHJcbiAgcmVzLnN0YXR1cyg0MDMpLmpzb24oe1xyXG4gICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICBtZXNzYWdlOiAnQWNlc3NvIG5lZ2Fkby4gVm9jw6ogc8OzIHBvZGUgYWNlc3NhciBzZXVzIHByw7NwcmlvcyByZWN1cnNvcydcclxuICB9KTtcclxufTsiXSwidmVyc2lvbiI6M30=